---
- name: Ensure developers group exists
  group:
    name: developers
    state: present

- name: Create devuser and add to developers group
  user:
    name: devuser
    groups: developers
    append: yes
    shell: /bin/bash
    password: 6684282bf0c558ae99560ccd9eea5c3ba9d36767132a11a8298bdc6fcb0d368d623fd1305f2c6ac2782a5356d425fc664661c3f9503e7b37c9c2401a05d8130c

- name: Create /opt/developers directory with restricted access
  file:
    path: /opt/developers
    state: directory
    owner: root
    group: developers
    mode: '0750'

- name: Update apt cache and install packages for H2
  apt:
    update_cache: yes
    name:
      - openjdk-17-jre-headless
      - ufw
      - curl
      - unzip
    state: present

- name: Ensure H2 directory exists
  file:
    path: /opt/h2
    state: directory
    mode: '0755'

- name: Download H2 jar
  get_url:
    url: "https://repo1.maven.org/maven2/com/h2database/h2/{{ h2_version }}/h2-{{ h2_version }}.jar"
    dest: "/opt/h2/h2-{{ h2_version }}.jar"
    mode: '0644'
  register: h2_jar_download
  until: h2_jar_download is succeeded
  retries: 3
  delay: 5

- name: Ensure H2 data directory exists and owned by vagrant
  file:
    path: /data/h2
    state: directory
    owner: vagrant
    group: vagrant
    mode: '0755'

- name: Check if H2 database already initialized (.mv.db)
  stat:
    path: /data/h2/payrolldb.mv.db
  register: h2_db_mv

- name: Check if H2 database already initialized (.h2.db)
  stat:
    path: /data/h2/payrolldb.h2.db
  register: h2_db_legacy

- name: Create init SQL script
  copy:
    dest: /tmp/init_payrolldb.sql
    content: |
      -- minimal init: create a marker table so H2 creates the DB files
      CREATE TABLE IF NOT EXISTS payroll_init (
        id INT PRIMARY KEY,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP()
      );
    mode: '0644'
  when: not h2_db_mv.stat.exists and not h2_db_legacy.stat.exists

- name: Initialize H2 database files if missing
  command: >-
    /usr/bin/java -cp "/opt/h2/h2-{{ h2_version }}.jar" org.h2.tools.RunScript
    -url "jdbc:h2:/data/h2/payrolldb" -user sa -password password -script "/tmp/init_payrolldb.sql"
  become_user: vagrant
  when: not h2_db_mv.stat.exists and not h2_db_legacy.stat.exists

- name: Remove init SQL script
  file:
    path: /tmp/init_payrolldb.sql
    state: absent

- name: Move H2 database to restricted directory
  command: mv /data/h2 /opt/developers/h2-db
  args:
    creates: /opt/developers/h2-db

- name: Set ownership and permissions for H2 database directory
  file:
    path: /opt/developers/h2-db
    owner: root
    group: developers
    mode: '0770'
    recurse: yes

- name: Install systemd unit for H2
  template:
    src: h2.service.j2
    dest: /etc/systemd/system/h2.service
    mode: '0644'

- name: Ensure UFW is enabled with default deny incoming
  ufw:
    state: enabled
    direction: incoming
    policy: deny

- name: Ensure OpenSSH is allowed through UFW
  ufw:
    rule: allow
    name: OpenSSH
    comment: "Allow SSH access"

- name: Allow app server access to H2 port
  ufw:
    rule: allow
    proto: tcp
    from_ip: "{{ app_ip }}"
    to_port: 9092
    comment: "Allow app to connect to H2"

- name: Reload systemd
  systemd:
    daemon_reload: yes

- name: Ensure H2 service is enabled and started
  systemd:
    name: h2
    enabled: yes
    state: started
  when: start_db | bool

- name: Ensure H2 service is disabled and stopped when requested
  systemd:
    name: h2
    enabled: no
    state: stopped
  when: not (start_db | bool)
