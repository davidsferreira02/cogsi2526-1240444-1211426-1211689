---
- name: Ensure developers group exists
  group:
    name: developers
    state: present

- name: Create devuser and add to developers group
  user:
    name: devuser
    groups: developers
    append: yes
    shell: /bin/bash
    password: 6684282bf0c558ae99560ccd9eea5c3ba9d36767132a11a8298bdc6fcb0d368d623fd1305f2c6ac2782a5356d425fc664661c3f9503e7b37c9c2401a05d8130c

- name: Create /opt/developers directory with restricted access
  file:
    path: /opt/developers
    state: directory
    owner: root
    group: developers
    mode: '0750'

- name: Ensure required packages are installed
  apt:
    update_cache: yes
    cache_valid_time: 3600
    name:
      - openjdk-17-jdk
      - maven
      - gradle
      - curl
      - jq
      - netcat-openbsd
    state: present

- name: Check if application.properties exists
  stat:
    path: "{{ app_project_dir }}/app/src/main/resources/application.properties"
  register: app_props

- name: Configure Spring app datasource and JPA settings
  blockinfile:
    path: "{{ app_project_dir }}/app/src/main/resources/application.properties"
    marker: "# {mark} ANSIBLE MANAGED BLOCK: Datasource and JPA"
    create: yes
    block: |
      spring.datasource.url=jdbc:h2:tcp://{{ db_ip }}:9092//opt/developers/h2-db/payrolldb
      spring.datasource.driverClassName=org.h2.Driver
      spring.datasource.username=sa
      spring.datasource.password=password
      spring.jpa.hibernate.ddl-auto=update
  when: app_project_dir is defined

- name: Build Spring Boot application
  command: ./gradlew bootJar
  args:
    chdir: "{{ app_project_dir }}"
  register: build_result
  changed_when: "'BUILD SUCCESSFUL' in build_result.stdout"
  failed_when:
    - build_result.rc != 0
    - "'BUILD FAILED' in build_result.stdout"
  retries: 2
  delay: 10
  until: "'BUILD SUCCESSFUL' in build_result.stdout"
  when: build_app | bool
  environment:
    JAVA_HOME: "/usr/lib/jvm/java-17-openjdk-amd64"


- name: Wait for H2 database to be ready
  wait_for:
    host: "{{ db_ip }}"
    port: 9092
    delay: 1
    timeout: 120
  register: wait_result
  failed_when: wait_result is failed and "'timed out' in wait_result.msg"
  retries: 3
  delay: 5
  until: wait_result is succeeded

- name: Find built JARs recursively under build/libs
  find:
    paths: "{{ app_project_dir }}/app/build/libs"
    patterns: "*.jar"
    recurse: yes
  register: found_jars
  failed_when: found_jars.matched == 0
  retries: 2
  delay: 5
  until: found_jars.matched > 0

- name: Narrow candidates to app/build/libs
  set_fact:
    app_jars_in_libs: "{{ found_jars.files | selectattr('path','search','/app/build/libs/') | list }}"

- name: Prefer non-plain Spring Boot JARs (by newest mtime)
  set_fact:
    app_jar: >-
      {{
        (
          (app_jars_in_libs | rejectattr('path','search','-plain') | sort(attribute='mtime'))
          | last
        ).path
        if ((app_jars_in_libs | rejectattr('path','search','-plain')) | length) > 0
        else (
          (app_jars_in_libs | sort(attribute='mtime')) | last
        ).path if (app_jars_in_libs | length) > 0 else ''
      }}
  failed_when: app_jar | length == 0

- name: Fail if no boot jar found
  fail:
    msg: "No Spring Boot jar found under {{ app_project_dir }}/app/build/libs (looked recursively)."
  when: app_jar | length == 0

- name: Copy Spring Boot JAR to restricted directory
  copy:
    src: "{{ app_jar }}"
    dest: /opt/developers/spring-app.jar
    owner: root
    group: developers
    mode: '0640'
    remote_src: yes

- name: Install systemd unit for CA4 app
  template:
    src: ca4-app.service.j2
    dest: /etc/systemd/system/ca4-app.service
    mode: '0644'

- name: Reload systemd
  systemd:
    daemon_reload: yes

- name: Ensure CA4 app service is enabled and started
  systemd:
    name: ca4-app
    enabled: yes
    state: started
  when: start_app | bool

- name: Ensure CA4 app service is disabled and stopped when requested
  systemd:
    name: ca4-app
    enabled: no
    state: stopped
  when: not (start_app | bool)
